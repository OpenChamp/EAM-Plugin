name: Build and Release Extension

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up CMake
        uses: cmake-action/cmake-action@v0.0.1
        with:
          cmake-version: '3.28'

      - name: Set up Visual Studio
        uses: microsoft/setup-msbuild@v1.1

      - name: Create build directory
        run: New-Item -ItemType Directory -Force -Path build

      - name: Configure CMake
        run: |
          cd build
          cmake -G "Visual Studio 17 2022" -A x64 ..

      - name: Build Release
        run: |
          cd build
          cmake --build . --config Release

      - name: Create addon zip
        run: |
          $zipPath = "eam-addon.zip"
          Compress-Archive -Path addons/eam -DestinationPath $zipPath
          Write-Host "Created zip file: $zipPath"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: eam-addon.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: eam-addon
          path: eam-addon.zip
